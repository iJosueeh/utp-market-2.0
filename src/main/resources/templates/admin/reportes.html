<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{admin/_admin_layout :: layout(title='Admin - Reportes', pageContent=~{::pageContent}, includeChartJS_=true)}">

<th:block th:fragment="pageContent">
    <div class="container-fluid">
        <h1 class="h3 mb-4 text-gray-800">Reportes de Ventas</h1>

        <!-- Loading -->
        <div id="loadingMsg" style="font-size: 15px; color: #777;">Cargando gr치fico...</div>

        <!-- Canvas -->
        <canvas id="ventasChart" style="max-height: 350px; display:none;"></canvas>

        <script>
            async function cargarVentas() {
                const loadingMsg = document.getElementById("loadingMsg");
                const canvas = document.getElementById("ventasChart");

                try {
                    const resp = await fetch("/admin/reportes/api/ventas-semanales");

                    if (!resp.ok) {
                        throw new Error("Error al obtener datos");
                    }

                    const json = await resp.json();

                    // Oculta loading, muestra gr치fico
                    loadingMsg.style.display = "none";
                    canvas.style.display = "block";

                    // Crear gr치fico
                    new Chart(canvas, {
                        type: "bar",
                        data: {
                            labels: json.labels,
                            datasets: [{
                                label: "Ventas (S/.)",
                                data: json.data,
                                borderWidth: 2,
                                backgroundColor: "rgba(75, 192, 192, 0.55)",
                                borderColor: "rgba(75, 192, 192, 1)",
                                hoverBackgroundColor: "rgba(75, 192, 192, 0.75)",
                                borderRadius: 6
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            animation: {
                                duration: 900,
                                easing: "easeOutQuart"
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: { color: "rgba(0,0,0,0.05)" }
                                },
                                x: {
                                    grid: { display: false }
                                }
                            }
                        }
                    });

                } catch (err) {
                    loadingMsg.style.color = "red";
                    loadingMsg.innerText = "No se pudo cargar el gr치fico ";
                }
            }

            cargarVentas();
        </script>
    </div>
</th:block>

</html>
